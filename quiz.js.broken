/**
 * CatchVoca Mobile Quiz - Firebase Version
 * Firebase Realtime Databaseì—ì„œ í€´ì¦ˆ ë°ì´í„° ë¡œë“œ
 */

// ============================================================================
// State Management
// ============================================================================

let words = [];
let currentIndex = 0;
let showingAnswer = false;
let firebaseApp = null;
let database = null;
let quizId = null;  // í€´ì¦ˆ ID ì €ì¥
let reviewStates = {};  // SM-2 ReviewState ì €ì¥ (wordId ê¸°ì¤€)

// ============================================================================
// Firebase Initialization
// ============================================================================

async function initializeFirebase() {
  // Firebase ëª¨ë“ˆì´ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
  while (!window.firebaseModules) {
    await new Promise(resolve => setTimeout(resolve, 100));
  }

  const { initializeApp, getDatabase } = window.firebaseModules;

  if (!firebaseApp) {
    firebaseApp = initializeApp(firebaseConfig);
    database = getDatabase(firebaseApp);
    console.log('[Quiz] Firebase initialized');
  }

  return database;
}

// ============================================================================
// Data Loading
// ============================================================================

/**
 * URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ í€´ì¦ˆ ID ì¶”ì¶œ
 */
function getQuizIdFromUrl() {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get('id');
}

/**
 * Firebaseì—ì„œ í€´ì¦ˆ ë°ì´í„° ë¡œë“œ
 */
async function loadQuizDataFromFirebase(id) {
  try {
    console.log('[Quiz] Loading from Firebase...', id);

    const db = await initializeFirebase();
    const { ref, get } = window.firebaseModules;

    const quizRef = ref(db, `${FIREBASE_PATHS.QUIZZES}/${id}`);
    const snapshot = await get(quizRef);

    if (!snapshot.exists()) {
      showError('Quiz not found', 'The quiz link may have expired (7 days limit) or is invalid.');
      return null;
    }

    const quizData = snapshot.val();

    // ë§Œë£Œ í™•ì¸
    if (quizData.expiresAt < Date.now()) {
      showError('Quiz expired', 'This quiz has expired. Please generate a new link.');
      return null;
    }

    // ê¸°ì¡´ reviewStates ë¡œë“œ
    if (quizData.reviewStates) {
      reviewStates = quizData.reviewStates;
      console.log('[Quiz] Loaded existing reviewStates:', reviewStates);
    }

    console.log(`[Quiz] Loaded ${quizData.words.length} words from Firebase`);
    return quizData.words
  } catch (error) {
    console.error('[Quiz] Firebase load error:', error);
    showError('Failed to load quiz', error.message || 'Please check your internet connection.');
    return null;
  }
}

/**
 * í€´ì¦ˆ ë°ì´í„° ë¡œë“œ (ë©”ì¸ í•¨ìˆ˜)
 */
async function loadQuizData() {
  const urlQuizId = getQuizIdFromUrl();

  if (!urlQuizId) {
    showError('Quiz ID not found in URL.', 'Please generate a quiz link from CatchVoca Extension.');
    return null;
  }

  // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
  quizId = urlQuizId;

  // Firebaseì—ì„œ ë¡œë“œ
  return await loadQuizDataFromFirebase(quizId)
}

/**
 * ì—ëŸ¬ í‘œì‹œ
 */
function showError(mainMessage, detailMessage = '') {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('error').style.display = 'flex';

  const errorMessageEl = document.getElementById('error-message');
  errorMessageEl.innerHTML = `<strong>${mainMessage}</strong>`;

  if (detailMessage) {
    errorMessageEl.innerHTML += `<br><small>${detailMessage}</small>`;
  }
}

// ============================================================================
// Quiz Initialization
// ============================================================================

/**
 * í€´ì¦ˆ ì´ˆê¸°í™”
 */
async function initQuiz() {
  console.log('[Quiz] Initializing...');

  // í€´ì¦ˆ ë°ì´í„° ë¡œë“œ
  words = await loadQuizData();

  if (!words || words.length === 0) {
    return;
  }

  // UI ì „í™˜
  document.getElementById('loading').style.display = 'none';
  document.getElementById('quiz-container').style.display = 'block';

  // Total count ì—…ë°ì´íŠ¸
  document.getElementById('total').textContent = words.length;

  // ì²« ë²ˆì§¸ ë‹¨ì–´ í‘œì‹œ
  showWord(0);

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  setupEventListeners();

  console.log('[Quiz] Initialization complete');
}

/**
 * ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
 */
function setupEventListeners() {
  // ë‹µë³€ í† ê¸€ ë²„íŠ¼
  document.getElementById('show-answer').addEventListener('click', toggleAnswer);

  // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼
  document.getElementById('prev-btn').addEventListener('click', () => navigateWord(-1));
  document.getElementById('next-btn').addEventListener('click', () => navigateWord(1));

  // ì˜¤ë””ì˜¤ ì¬ìƒ ë²„íŠ¼
  document.getElementById('play-audio').addEventListener('click', playAudio);

  // í‰ê°€ ë²„íŠ¼
  document.querySelectorAll('.rating-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const rating = parseInt(e.currentTarget.dataset.rating);
      handleRating(rating);
    });
  });

  // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
  document.addEventListener('keydown', handleKeydown)
}

// ============================================================================
// Word Display
// ============================================================================

/**
 * íŠ¹ì • ì¸ë±ìŠ¤ì˜ ë‹¨ì–´ í‘œì‹œ
 */
function showWord(index) {
  if (index < 0 || index >= words.length) {
    console.error('[Quiz] Invalid index:', index);
    return;
  }

  currentIndex = index;
  const word = words[index];
  showingAnswer = false;

  console.log(`[Quiz] Showing word ${index + 1}/${words.length}:`, word.w);

  // ë‹¨ì–´ ë° ë°œìŒ ê¸°í˜¸
  document.getElementById('word-text').textContent = word.w;
  document.getElementById('phonetic').textContent = word.p || '';

  // ì§„í–‰ ìƒí™©
  document.getElementById('current').textContent = index + 1;

  // ë‹µë³€ ì´ˆê¸°í™”
  hideAnswer();

  // ì •ì˜ ë Œë”ë§
  renderDefinitions(word.d);

  // ì˜¤ë””ì˜¤ ë²„íŠ¼
  const audioBtn = document.getElementById('play-audio');
  if (word.a) {
    audioBtn.style.display = 'inline-block';
    audioBtn.dataset.audioUrl = word.a;
  } else {
    audioBtn.style.display = 'none';
  }

  // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ
  updateNavigationButtons();
}

/**
 * ì •ì˜ ëª©ë¡ ë Œë”ë§
 */
function renderDefinitions(definitions) {
  const definitionsList = document.getElementById('definitions-list');
  definitionsList.innerHTML = '';

  if (!definitions || definitions.length === 0) {
    const li = document.createElement('li');
    li.textContent = 'ì •ì˜ ì—†ìŒ';
    li.className = 'no-definition';
    definitionsList.appendChild(li);
    return;
  }

  definitions.forEach((def, index) => {
    const li = document.createElement('li');
    li.innerHTML = `<span class="def-number">${index + 1}.</span> ${def}`;
    definitionsList.appendChild(li);
  });
}

/**
 * ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
 */
function updateNavigationButtons() {
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');

  prevBtn.disabled = currentIndex === 0;
  nextBtn.disabled = currentIndex === words.length - 1;

  // ë§ˆì§€ë§‰ ë‹¨ì–´ì¼ ë•Œ "Finish" í‘œì‹œ
  if (currentIndex === words.length - 1) {
    nextBtn.textContent = 'Finish ğŸ‰';
  } else {
    nextBtn.textContent = 'Next â†’';
  }
}

// ============================================================================
// Answer Toggle
// ============================================================================

/**
 * ë‹µë³€ í‘œì‹œ/ìˆ¨ê¸°ê¸° í† ê¸€
 */
function toggleAnswer() {
  showingAnswer = !showingAnswer;

  if (showingAnswer) {
    showAnswer();
  } else {
    hideAnswer();
  }
}

/**
 * ë‹µë³€ í‘œì‹œ
 */
function showAnswer() {
  const answerContainer = document.getElementById('answer');
  const showAnswerBtn = document.getElementById('show-answer');

  answerContainer.style.display = 'block';
  showAnswerBtn.textContent = 'Hide Answer';
  showAnswerBtn.classList.add('active');
  showingAnswer = true;
}

/**
 * ë‹µë³€ ìˆ¨ê¸°ê¸°
 */
function hideAnswer() {
  const answerContainer = document.getElementById('answer');
  const showAnswerBtn = document.getElementById('show-answer');

  answerContainer.style.display = 'none';
  showAnswerBtn.textContent = 'Show Answer';
  showAnswerBtn.classList.remove('active');
  showingAnswer = false;
}

// ============================================================================
// Navigation
// ============================================================================

/**
 * ë‹¨ì–´ ë„¤ë¹„ê²Œì´ì…˜
 */
function navigateWord(direction) {
  const newIndex = currentIndex + direction;

  if (newIndex < 0 || newIndex >= words.length) {
    return;
  }

  // ë§ˆì§€ë§‰ ë‹¨ì–´ì—ì„œ "Finish" í´ë¦­ ì‹œ
  if (currentIndex === words.length - 1 && direction === 1) {
    showCompletionMessage();
    return;
  }

  showWord(newIndex);
}

/**
 * í€´ì¦ˆ ì™„ë£Œ ë©”ì‹œì§€
 */
function showCompletionMessage() {
  // í†µê³„ ê³„ì‚°
  const totalReviewed = Object.keys(progress).length;
  const avgRating = totalReviewed > 0
    ? Object.values(progress).reduce((sum, p) => sum + p.lastRating, 0) / totalReviewed
    : 0;

  const card = document.querySelector('.card');
  card.innerHTML = `
    <div class=\"completion-message\">
      <div class=\"emoji\">ğŸ‰</div>
      <h2>í•™ìŠµ ì™„ë£Œ!</h2>
      <p>ì´ ${words.length}ê°œ ë‹¨ì–´ ì¤‘ ${totalReviewed}ê°œë¥¼ ë³µìŠµí–ˆìŠµë‹ˆë‹¤.</p>
      <p class=\"subtitle\">í‰ê·  ë‚œì´ë„: ${avgRating.toFixed(1)}ì </p>
      <p class=\"subtitle\">ê¾¸ì¤€íˆ ë³µìŠµí•˜ì—¬ ê¸°ì–µì„ ê°•í™”í•˜ì„¸ìš”!</p>
      <button class=\"btn btn-primary\" onclick=\"location.reload()\">
        ë‹¤ì‹œ ì‹œì‘
      </button>
    </div>
  `;

  document.querySelector('.controls').style.display = 'none';
}

// ============================================================================

// ============================================================================
// SM-2 Algorithm (Same as PC Extension)
// ============================================================================

/**
 * SM-2 ì„¤ì •
 */
const SM2_CONFIG = {
  minEaseFactor: 1.3,
  maxEaseFactor: 2.5,
  firstInterval: 1,  // 1ì¼
  secondInterval: 6,  // 6ì¼
};

/**
 * Rating enum (1-5)
 */
const Rating = {
  Again: 1,      // ì™„ì „íˆ ëª» ì™¸ì›€
  Hard: 2,       // ì–´ë µê²Œ ê¸°ì–µ
  Good: 3,       // ë³´í†µ
  Easy: 4,       // ì‰½ê²Œ ê¸°ì–µ
  VeryEasy: 5,   // ë§¤ìš° ì‰½ê²Œ ê¸°ì–µ
};

/**
 * SM-2 ì•Œê³ ë¦¬ì¦˜ ê³„ì‚°
 */
function calculateNextReview(currentState, rating) {
  let { interval, easeFactor, repetitions } = currentState;

  // 1. EaseFactor ê³„ì‚°
  const newEaseFactor = Math.max(
    SM2_CONFIG.minEaseFactor,
    Math.min(
      SM2_CONFIG.maxEaseFactor,
      easeFactor + (0.1 - (5 - rating) * (0.08 + (5 - rating) * 0.02))
    )
  );

  // 2. í‰ê°€ì— ë”°ë¥¸ ê°„ê²© ë° ë°˜ë³µ íšŸìˆ˜ ê³„ì‚°
  let newInterval;
  let newRepetitions;

  if (rating < Rating.Good) {
    // Ratingì´ Good(3) ë¯¸ë§Œì´ë©´ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘
    newInterval = SM2_CONFIG.firstInterval;
    newRepetitions = 0;
  } else {
    // Ratingì´ Good(3) ì´ìƒì´ë©´ ì„±ê³µ
    newRepetitions = repetitions + 1;

    if (newRepetitions === 1) {
      newInterval = SM2_CONFIG.firstInterval;
    } else if (newRepetitions === 2) {
      newInterval = SM2_CONFIG.secondInterval;
    } else {
      newInterval = Math.round(interval * newEaseFactor);
    }
  }

  // 3. ë‹¤ìŒ ë³µìŠµ ì‹œê° ê³„ì‚°
  const now = Date.now();
  const nextReviewAt = now + newInterval * 24 * 60 * 60 * 1000;

  return {
    nextReviewAt,
    interval: newInterval,
    easeFactor: newEaseFactor,
    repetitions: newRepetitions,
  };
}

// ============================================================================
// Rating System (SM-2 Simplified)
// ============================================================================

/**
 * í‰ê°€ ì²˜ë¦¬
 */
async function handleRating(rating) {
  console.log(`[Quiz] Rating ${rating} for word ${currentIndex}`);

  const word = words[currentIndex];
  if (!word) return;

  // WordID ìƒì„± (word + url ì¡°í•©)
  const wordId = `${word.w}::${quizId}`;

  // í˜„ì¬ ReviewState ê°€ì ¸ì˜¤ê¸° ë˜ëŠ” ì´ˆê¸°í™”
  let currentState = reviewStates[wordId];
  if (!currentState) {
    // ì²« í•™ìŠµ: ì´ˆê¸° ReviewState ìƒì„±
    currentState = {
      wordId: wordId,
      nextReviewAt: Date.now(),
      interval: 1,
      easeFactor: 2.5,
      repetitions: 0,
    };
  }

  // SM-2 ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ë‹¤ìŒ ë³µìŠµ ì¼ì • ê³„ì‚°
  const sm2Result = calculateNextReview(currentState, rating);

  // ReviewState ì—…ë°ì´íŠ¸
  reviewStates[wordId] = {
    wordId: wordId,
    nextReviewAt: sm2Result.nextReviewAt,
    interval: sm2Result.interval,
    easeFactor: sm2Result.easeFactor,
    repetitions: sm2Result.repetitions,
    lastRating: rating,
    lastReviewedAt: Date.now(),
  };

  // Firebaseì— ì €ì¥
  await saveReviewStateToFirebase(wordId);

  // í”¼ë“œë°± í‘œì‹œ
  showRatingFeedback(rating, sm2Result.interval);

  // 1ì´ˆ í›„ ë‹¤ìŒ ë‹¨ì–´ë¡œ ì´ë™
  setTimeout(() => {
    if (currentIndex < words.length - 1) {
      navigateWord(1);
    } else {
      showCompletionMessage();
    }
  }, 1000);
}

  progress[currentIndex].ratings.push(rating);
  progress[currentIndex].lastRating = rating;
  progress[currentIndex].reviewedAt = Date.now();

  // Firebaseì— ì €ì¥
  await saveProgressToFirebase();

  // í”¼ë“œë°± í‘œì‹œ
  showRatingFeedback(rating);

  // 1ì´ˆ í›„ ë‹¤ìŒ ë‹¨ì–´ë¡œ ì´ë™
  setTimeout(() => {
    if (currentIndex < words.length - 1) {
      navigateWord(1);
    } else {
      showCompletionMessage();
    }
  }, 1000);
}

/**
 * Firebaseì— ì§„í–‰ë¥  ì €ì¥
 */
async function saveProgressToFirebase() {
  if (!quizId || !database) return;

  try {
    const { ref, update } = window.firebaseModules;
    const progressRef = ref(database, `${FIREBASE_PATHS.QUIZZES}/${quizId}/progress`);

    await update(progressRef, {
      [currentIndex]: progress[currentIndex]
    });

    console.log('[Quiz] Progress saved to Firebase');
  } catch (error) {
    console.error('[Quiz] Failed to save progress:', error);
  }
}

/**
 * í‰ê°€ í”¼ë“œë°± í‘œì‹œ
 */
function showRatingFeedback(rating) {
  const feedbackMessages = {
    1: 'âŒ ë‹¤ì‹œ ë³µìŠµì´ í•„ìš”í•´ìš”!',
    2: 'ğŸ˜“ ì¡°ê¸ˆ ë” ì—°ìŠµí•´ë³´ì„¸ìš”',
    3: 'ğŸ¤” ê´œì°®ì•„ìš”!',
    4: 'âœ… ì™„ë²½í•´ìš”!'
  };

  const message = feedbackMessages[rating] || 'í‰ê°€ ì™„ë£Œ';
  
  // ê°„ë‹¨í•œ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
  const toast = document.createElement('div');
  toast.className = 'rating-toast';
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 16px 24px;
    border-radius: 8px;
    font-size: 18px;
    z-index: 1000;
    animation: fadeInOut 1s ease-in-out;
  `;

  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 1000);
}
// Audio Playback
// ============================================================================

/**
 * ì˜¤ë””ì˜¤ ì¬ìƒ
 */
function playAudio() {
  const audioBtn = document.getElementById('play-audio');
  const audioUrl = audioBtn.dataset.audioUrl;

  if (!audioUrl) {
    return;
  }

  const audio = new Audio(audioUrl);

  audio.play().catch((error) => {
    console.error('[Quiz] Audio play error:', error);
    alert('Failed to play audio.');
  });

  // Visual feedback
  audioBtn.textContent = 'ğŸ”Š Playing...';
  audioBtn.disabled = true;

  audio.addEventListener('ended', () => {
    audioBtn.textContent = 'ğŸ”Š Play';
    audioBtn.disabled = false;
  });

  audio.addEventListener('error', () => {
    audioBtn.textContent = 'ğŸ”Š Play';
    audioBtn.disabled = false;
  });
}

// ============================================================================
// Keyboard Shortcuts
// ============================================================================

/**
 * í‚¤ë³´ë“œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
 */
function handleKeydown(event) {
  if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
    return;
  }

  switch (event.key) {
    case 'ArrowLeft':
      event.preventDefault();
      navigateWord(-1);
      break;

    case 'ArrowRight':
      event.preventDefault();
      navigateWord(1);
      break;

    case ' ':
      event.preventDefault();
      toggleAnswer();
      break;

    default:
      break;
  }
}

// ============================================================================
// Initialization
// ============================================================================

/**
 * DOMContentLoaded ì´ë²¤íŠ¸ ì‹œ ì´ˆê¸°í™”
 */
window.addEventListener('DOMContentLoaded', () => {
  console.log('[Quiz] DOM loaded');
  initQuiz();
});
